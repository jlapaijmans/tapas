# Just in case someone executes this as a script
set -ueC
#' Set variables
#' =============

#' Script paths
s_map_bwa="$pr/mapper-compare/bwa/map-reads-bwa.sh"
s_cross_tab="$pr/scripts/cross_tab.py"
s_table2calls="$pr/scripts/table2calls.py"
s_mcall="$pr/scripts/mcall.py"
s_mapping_stat="$pr/mapper-compare/eval/mapping-stat.R"
s_index_column="$pr/scripts/index-column.py"

#' Output directory
outd="$pr/data/gen/bwa_runs"
mkdir $outd
cd $outd

#' Reference path
uspemito_ref="$pr/mapper-compare/bwa/Usp_mito/Usp_mito"

#' Input: Generated FASTQ files with differing mutation rates
d_fastq="$pr/data/gen/multi-origin_reads"

#' Generate BWA calls
#' ==================

mkdir par

#' Write other BWA parameters to files
cat > par/n <<EOF
n
1
2
4
5
EOF

cat > par/l <<EOF
l
999
4
EOF

cat > par/k <<EOF
k
2
10
EOF

cat > par/M <<EOF
M
3
1
10
EOF

#' Write a table of all combinations  of the above parameters
$s_cross_tab
$s_cross_tab --head 1 $outd/par/* $d_fastq/mut.tab > par.tab
head par.tab

#' add an index column to the table
$s_index_column --inplace par.tab
head par.tab 

#' Create a template for a mapping script call

$s_map_bwa -h
mkdir log

bwa_template="$s_map_bwa \
    $d_fastq/all_c_{mut}.fastq \
    $uspemito_ref   \
    runs/{index} \
    -n{n} -l{l} -k{k} -M{M} \
    > log/{index}.log 2>&1"

#' Assemble the multirun-descripton file
echo $bwa_template > bwa.mcall
echo ---           >>bwa.mcall
cat par.tab  >> bwa.mcall

# head bwa.mcall > bwa_t.mcall
# cat bwa_t.mcall

#' Generate the read list
$s_table2calls $outd/bwa.mcall > bwa.calls
head bwa.calls

#' Run these commands using a maximum of 6 processes
$s_mcall -c bwa.calls -t 10 > mcall.out 2>&1 &
tail mcall.out

#' Remove .sai files and compress the .sam files
for f in $(ls runs); do
    mv runs/$f/aln.sam runs/${f}.sam
    rm runs/$f/aln.sai
    rm -r runs/$f
done

old_ref_name="gi|195661114|ref|NC_011112.1|"
new_ref_name="uspemito"
for sam in runs/*; do 
    sed -i "s/$old_ref_name/$new_ref_name/g" $sam
done

for sam in runs/*; do
    echo "gzip $sam"
done | $s_mcall -t 10


# vim: tw=80:ft=sh


